define("bundles/assess/assessmentTypes/phoenixQuiz/assessment",["require","exports","module","jquery","moment","underscore","bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html","bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html","bundles/ondemand/components/LockingCover","bundles/ondemand/stores/StoreComputationHelpers","bundles/page/lib/metatagsAddressBook","bundles/phoenix/components/TimeDuration","bundles/phoenix/lib/view","bundles/phoenix/template/models/userIdentity","bundles/assess/components/NumberOfAttempts","bundles/ondemand/utils/deadlineFormatter","js/lib/modals","js/lib/pluralize","pages/open-course/assessment/models/relativePassingStates","pages/open-course/common/utils/ensureEnrolled","pages/open-course/common/views/performanceBar","js/lib/tooltips"],function(require,exports,module){"use strict";var $=require("jquery"),s=require("moment"),_=require("underscore"),d=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html"),u=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html"),h=require("bundles/ondemand/components/LockingCover"),g=require("bundles/ondemand/stores/StoreComputationHelpers"),f=g.getDeadlineForItem,n=require("bundles/page/lib/metatagsAddressBook"),t=require("bundles/phoenix/components/TimeDuration"),r=require("bundles/phoenix/lib/view"),v=require("bundles/phoenix/template/models/userIdentity"),m=require("bundles/assess/components/NumberOfAttempts"),i=require("bundles/ondemand/utils/deadlineFormatter"),a=require("js/lib/modals"),c=require("js/lib/pluralize"),p=require("pages/open-course/assessment/models/relativePassingStates"),o=require("pages/open-course/common/utils/ensureEnrolled"),b=require("pages/open-course/common/views/performanceBar");require("js/lib/tooltips");var e=function getMetadata(e){return function(){return this.model.get("metadata").get(e)}},l=r.extend({name:"itemView",bodyClasses:"c-item-assessment",multitracker:{namespace:"open_course.item_page.quiz",baseValues:["open_course_slug","module_id","module_name","lesson_id","lesson_name","item_id","item_name"],definitions:{open_course_slug:e("course.slug"),module_id:e("lesson.module.id"),module_name:e("lesson.module.name"),lesson_id:e("lesson.id"),lesson_name:e("lesson.name"),item_id:e("id"),item_name:e("name")},events:{start:[],resume:[]},eventingVersion:2},events:{'click [data-js~="start-button"]':"start",'click [data-js~="retake-button"]':"start",'click [data-js~="review-button"]':"review",'click [data-js~="confirm-start-button"]':"confirmedStart",'click [data-js~="stay-button"]':"closeModal"},firstReview:!0,initialize:function initialize(e){$("body").addClass(this.bodyClasses),_.bindAll(this,"confirmedStart"),this.onStateChange=e.onStateChange,this.verificationDisplay=e.verificationDisplay,this.itemGrade=e.itemGrade,this.courseSlug=this.model.get("metadata.course.slug"),this.moduleNumber=this.model.get("metadata.lesson.module.index"),this.authenticated=v.get("authenticated"),this.isVerificationEnabled=this.model.get("metadata.course").isVerificationEnabled(),this.initializePerformanceBar(),this.on("view:closing",this.onClose,this),n.setMetatags({pageName:"title-and-description",context:{title:this.model.get("metadata.name"),description:this.model.get("metadata.lesson.module.description")},options:{imageHref:this.model.get("metadata.course.promoPhoto")}}),e.params&&e.params.question_id&&this.firstReview&&(this.firstReview=!1,this.review())},initializePerformanceBar:function initializePerformanceBar(){var e=this.model.getDisplayEvaluation(this.verificationDisplay);this.authenticated&&e&&(this.performanceBar=new b({evaluation:e,showValue:!1,disableTransitions:!0}))},onClose:function onClose(){$("body").removeClass(this.bodyClasses)},closeModal:function closeModal(){if(!this.modal)return;this.modal.close(),this.modal=null},startQuiz:function startQuiz(){if("exam"===this.model.get("metadata").getTypeName()&&this.model.isLastAttemptBeforeLock()){this.closeModal();var e=this.fluxibleContext.getComponentContext().getStore("SessionStore");e.isSessionsEnabled()?this.modal=a(this.$$("last-attempt-session-modal")):this.modal=a(this.$$("last-attempt-ondemand-modal")),this.modal.open()}else this.confirmedStart()},start:function start(){var e=this.fluxibleContext.getComponentContext().getStore("ApplicationStore"),t=this.fluxibleContext.getComponentContext().getStore("CourseStore");if(!e.ensureAuthenticated())return null;var s=e.getUserData().id,i=t.getMetadata();o(s,i,this.verificationDisplay).then(this.startQuiz.bind(this)).fail(function(e){if(!(e instanceof o.UserRejectedEnrollPromptException))throw e}).done()},confirmedStart:function confirmedStart(){this.closeModal(),this.model.hasUnsubmittedAttempt()?this.track("resume"):this.track("start"),this.onStateChange("attempt")},openVerificationModule:function openVerificationModule(){this.onStateChange("verify")},review:function review(){this.onStateChange("attempt",{attemptIndex:this.model.getLastSubmittedAttempt()})},render:function render(){var e=this.fluxibleContext.getComponentContext(),t=e.getStore("SessionStore"),a=u;"exam"===this.model.get("metadata").getTypeName()&&(a=d);var r=this.model.getDisplayEvaluation(this.verificationDisplay),l=this.model.getRelativePassingState(this.verificationDisplay),o={model:this.model,pluralize:c,moment:s,authenticated:this.authenticated,evaluation:r,relativePassingState:l,relativePassingStates:p,isItemLocked:this.model.get("metadata").isLockedForSessions()};if(t.isEnrolled()){var m=e.getStore("CourseScheduleStore"),h=e.getStore("ProgressStore"),n=f(m,h,this.model.get("metadata")),g=this.model.get("bestEvaluation")&&this.model.get("bestEvaluation").getHumanPercentScore();_(o).extend({enrolledInSession:!0,deadline:i.getFormattedDeadline(n),hasDeadlinePassed:s().isAfter(n),courseDeadline:i.getFormattedDeadline(t.getEndDate()),bestScore:g})}return this.$el.html(a(o)),this.renderSubviews(),this.renderRetakeButton(),this.authenticated&&this.model.hasSubmittedAttempt()&&this.model.examIsLocked&&this.model.examIsLocked()&&this.track("time_lock.render"),this},renderSubviews:function renderSubviews(){this.performanceBar&&this.$$("performance-bar-container").html(this.performanceBar.render().el);var o=this.model.get("metadata").isLockedForSessions();if(o&&this.renderReactInto(h,"LockingCover",{itemMetadata:this.model.get("metadata")}),"exam"===this.model.get("metadata").getTypeName()){var e=this.model.get("metadata"),s=e.getDefinition("allowedSubmissionsPerInterval"),n=1===s,i=e.getDefinition("allowedSubmissionsInterval"),l=this.model.get("locksIfSubmittedBefore")-Date.now(),a=n?i:l;this.renderReactIntoAll(t,"ShortIntervalDisplay",{duration:i,showNumberIfSingular:!1},void 0,!0),this.renderReactIntoAll(t,"RemainingIntervalDisplay",{duration:a,showNumberIfSingular:!1},void 0,!0),this.renderReactIntoAll(t,"RemainingIntervalFullDisplay",{duration:a,showNumberIfSingular:!0},void 0,!0),this.renderReactIntoAll(m,"NumberOfAttempts",{numberOfAttempts:s},void 0,!0)}},renderRetakeButton:function renderRetakeButton(){"exam"===this.model.get("metadata").getTypeName()&&this.$$("retake-button").attr("disabled",this.model.examIsLocked())}});module.exports=l});