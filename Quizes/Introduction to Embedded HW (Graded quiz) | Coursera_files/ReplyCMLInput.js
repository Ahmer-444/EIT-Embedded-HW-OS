define("bundles/discussions/components/repliesList/ReplyCMLInput",["require","exports","module","underscore","react","react-dom","classnames","bundles/cml/components/CMLOrFallbackEditor","bundles/discussions/components/repliesList/ReplyFollow","bundles/cml/utils/CMLUtils","bundles/discussions/utils/DiscussionsCMLUtils","bundles/cml/constants/CMLEditorPlugins","bundles/discussions/constants","bundles/discussions/constants","bundles/discussions/actions/ThreadDetailsActions","bundles/discussions/actions/ThreadsActions","bundles/page/components/TrackedButton","bundles/discussions/utils/generateReplyData","js/lib/connectToRouter","bundles/discussions/components/discussionsForumsHOC","bundles/discussions/utils/routerConnectToCurrentForum","bundles/naptimejs/resources/onDemandCourseForums.v1","bundles/naptimejs/resources/onDemandMentorForums.v1","bundles/naptimejs/resources/groupForums.v1","js/lib/mapProps","i18n!nls/discussions","css!./__styles__/ReplyCML"],function(require,exports,module){"use strict";function _defaults(e,n){for(var i=Object.getOwnPropertyNames(n),s=0;s<i.length;s++){var t=i[s],o=Object.getOwnPropertyDescriptor(n,t);o&&o.configurable&&void 0===e[t]&&Object.defineProperty(e,t,o)}return e}function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(s,e){if(!s)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?s:e}function _inherits(s,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);s.prototype=Object.create(e&&e.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(s,e):_defaults(s,e))}var s,r,b=require("underscore"),f=b.compose,e=require("react"),i=require("react-dom"),l=require("classnames"),a=require("bundles/cml/components/CMLOrFallbackEditor"),d=require("bundles/discussions/components/repliesList/ReplyFollow"),p=require("bundles/cml/utils/CMLUtils"),t=require("bundles/discussions/utils/DiscussionsCMLUtils"),m=require("bundles/cml/constants/CMLEditorPlugins"),u=require("bundles/discussions/constants"),c=require("bundles/discussions/constants"),o=c.savingStates,h=require("bundles/discussions/actions/ThreadDetailsActions"),g=h.savePost,y=require("bundles/discussions/actions/ThreadsActions"),F=y.clearThreadsCache,v=require("bundles/page/components/TrackedButton"),T=require("bundles/discussions/utils/generateReplyData"),P=require("js/lib/connectToRouter"),C=require("bundles/discussions/components/discussionsForumsHOC"),E=require("bundles/discussions/utils/routerConnectToCurrentForum"),w=require("bundles/naptimejs/resources/onDemandCourseForums.v1"),O=require("bundles/naptimejs/resources/onDemandMentorForums.v1"),R=require("bundles/naptimejs/resources/groupForums.v1"),S=require("js/lib/mapProps"),n=require("i18n!nls/discussions");require("css!./__styles__/ReplyCML");var D=u.naptimeForumTypes,j=(r=s=function(s){function ReplyCMLInput(o,n){_classCallCheck(this,ReplyCMLInput);var e=_possibleConstructorReturn(this,s.call(this,o,n));return e.setFocus=function(){e.setState({isFocused:!0})},e.removeFocus=function(){e.setState({isFocused:!1})},e.handleInputChange=function(s){var o=!t.validateLength(s),n=!0;e.setState({cml:s,hasErrors:o,submitEnabled:n})},e.handleSubmit=function(){var t=e.state,l=t.cml,o=t.isFollowing,d=t.hasErrors,s=e.props,r=s.parentPost,c=s.contextId,u=s.currentForum,a=s.question;if(d)return void i.findDOMNode(e.refs.content.refs.editorWrapper.refs.editor).focus();var n=u&&u.forumType.typeName,p=T(r,c,l,n,o);e.context.executeAction(F),e.context.executeAction(g,{options:p,question:a,parentPost:r,forumType:n,isFollowing:o}),e.setState({submitEnabled:!1})},e.handleFocus=function(){e.setState({isFocused:!0})},e.handleFollow=function(s){e.setState({isFollowing:s})},e.state=e.getDefaultState(),e}return _inherits(ReplyCMLInput,s),ReplyCMLInput.prototype.componentWillReceiveProps=function componentWillReceiveProps(e){e.savingState!==this.props.savingState&&(e.savingState===o.SAVED?this.setState(Object.assign(this.getDefaultState(),{editorKey:this.state.editorKey+1})):e.savingState===o.ERROR),this.props.shouldFocusCounter<e.shouldFocusCounter&&this.focus(),e.question&&e.question.isFollowing!==this.state.isFollowing&&this.setState({isFollowing:e.question.isFollowing})},ReplyCMLInput.prototype.getDefaultState=function getDefaultState(){var e=[],s=this.props,o=s.question,n=s.parentPost;return"answer"===!n.type&&e.push(m.ToolbarVisibility),{blocks:t.getDefaultBlocks(),cml:p.create("",u.DTD_NAME),hasErrors:!1,submitEnabled:!1,disabledPlugins:e,focus:!1,editorKey:1,isFollowing:o&&o.isFollowing}},ReplyCMLInput.prototype.focus=function focus(){var e=this;setTimeout(function(){i.findDOMNode(e.refs.content.refs.editorWrapper.refs.editor).focus(),i.findDOMNode(e.refs.content.refs.editorWrapper.refs.editor).click()},0)},ReplyCMLInput.prototype.render=function render(){var i=this.props,h=i.parentPost,y=i.question,w=i.courseId,p=i.placeholder,m=i.savingState,b=i.hideFollow,s=this.state,r=s.cml,g=s.isFocused,c=s.blocks,F=s.disabledPlugins,T=s.isFollowing,P=s.editorKey,C=s.submitEnabled,E=s.hasErrors,u=t.generateContentLengthWarning(r),O=e.createElement("div",{className:"c-error-text c-form-error-message"},n("Something went wrong. Please reload the page and try again.")),R=l("rc-ReplyCML"),S=h.questionId,f=t.getImageUploadOptions(w,S);return e.createElement("div",{className:R},e.createElement("div",{className:"editor-container"},e.createElement(a,{cml:r,ref:"content",key:P,blocks:c,changeDelay:100,title:n("Post Reply"),onFocus:this.handleFocus,placeholder:n(p),disabledPlugins:F,onChange:this.handleInputChange,imageUploadOptions:f})),!!u&&e.createElement("div",{className:"horizontal-box align-items-right",style:{marginBottom:20}},u,m===o.ERROR&&O),e.createElement("div",{className:"horizontal-box align-items-right align-items-vertical-center"},e.createElement("div",{className:"flex-1"},g&&!b&&y&&e.createElement(d,{checked:T,onChange:this.handleFollow})),e.createElement(v,{ref:"submit",className:"secondary",onClick:this.handleSubmit,trackingName:"thread_reply",disabled:!C||E},n("Reply"))))},ReplyCMLInput}(e.Component),s.propTypes={parentPost:e.PropTypes.object.isRequired,savingState:e.PropTypes.string.isRequired,shouldFocusCounter:e.PropTypes.number,placeholder:e.PropTypes.string,currentForum:e.PropTypes.oneOfType([e.PropTypes.instanceOf(w),e.PropTypes.instanceOf(O),e.PropTypes.instanceOf(R)]),courseId:e.PropTypes.string,contextId:e.PropTypes.string,question:e.PropTypes.object,hideFollow:e.PropTypes.bool},s.contextTypes={executeAction:e.PropTypes.func.isRequired,router:e.PropTypes.object.isRequired},s.defaultProps={placeholder:"Reply",savingState:o.UNCHANGED},r);module.exports=f(C({fields:["link","title"]}),P(E),S(function(e){if(e.currentForum&&e.currentForum.forumType.typeName===D.groupForumType)return{contextId:e.currentForum.forumType.definition.groupId};return{contextId:e.courseId}}))(j)});