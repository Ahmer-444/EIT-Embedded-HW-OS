define("bundles/discussions/components/ModerationDropdown",["require","exports","module","jquery","jsuri","react-dom","react","underscore","bundles/discussions/actions/DropdownActions","bundles/discussions/components/Delete","bundles/discussions/components/EditThreadModal","bundles/discussions/components/EditWithModerationModal","bundles/discussions/components/FlaggingModal","bundles/discussions/components/ShareModal","bundles/discussions/components/HighlightModal","bundles/programming/utils/ProgrammingPermissionsUtils","pages/open-course/common/promises/groupAuthorizationPromise","bundles/naptimejs/resources/onDemandCourseForums.v1","bundles/naptimejs/resources/onDemandMentorForums.v1","bundles/naptimejs/resources/groupForums.v1","js/lib/connectToRouter","bundles/discussions/utils/routerConnectToCurrentForum","vendor/cnpm/fluxible.v0-4/addons/connectToStores","bundles/discussions/components/discussionsForumsHOC","bundles/discussions/utils/areHighlightedPostsEnabled","i18n!nls/discussions","css!./__styles__/ModerationDropdown"],function(require,exports,module){"use strict";function _defaults(e,n){for(var i=Object.getOwnPropertyNames(n),o=0;o<i.length;o++){var t=i[o],s=Object.getOwnPropertyDescriptor(n,t);s&&s.configurable&&void 0===e[t]&&Object.defineProperty(e,t,s)}return e}function _classCallCheck(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(o,e){if(!o)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?o:e}function _inherits(o,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);o.prototype=Object.create(e&&e.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(o,e):_defaults(o,e))}var s,i,$=require("jquery"),r=require("jsuri"),a=require("react-dom"),e=require("react"),_=require("underscore"),t=require("bundles/discussions/actions/DropdownActions"),l=t.showAdminDetails,d=t.hideAdminDetails,u=t.showReplyEditor,c=t.highlightPost,p=t.unhighlightPost,h=require("bundles/discussions/components/Delete"),v=require("bundles/discussions/components/EditThreadModal"),m=require("bundles/discussions/components/EditWithModerationModal"),g=require("bundles/discussions/components/FlaggingModal"),w=require("bundles/discussions/components/ShareModal"),f=require("bundles/discussions/components/HighlightModal"),b=require("bundles/programming/utils/ProgrammingPermissionsUtils"),M=require("pages/open-course/common/promises/groupAuthorizationPromise"),y=require("bundles/naptimejs/resources/onDemandCourseForums.v1"),D=require("bundles/naptimejs/resources/onDemandMentorForums.v1"),S=require("bundles/naptimejs/resources/groupForums.v1"),E=require("js/lib/connectToRouter"),T=require("bundles/discussions/utils/routerConnectToCurrentForum"),P=require("vendor/cnpm/fluxible.v0-4/addons/connectToStores"),C=require("bundles/discussions/components/discussionsForumsHOC"),j=require("bundles/discussions/utils/areHighlightedPostsEnabled"),o=require("i18n!nls/discussions");require("css!./__styles__/ModerationDropdown");var n=(i=s=function(t){function ModerationDropdown(o,s){_classCallCheck(this,ModerationDropdown);var e=_possibleConstructorReturn(this,t.call(this,o,s));return e.onEditClick=function(){var o=e.props,t=o.creator,s=o.userId,n=o.post,i=t.userId===s;i||"question"===n.type?e.showEdit():e.showEditWithModerationModal()},e.onFlaggingClick=function(){e.setState({showFlaggingModal:!0}),e.closeDropdown()},e.onShareClick=function(){e.setState({showShareModal:!0}),e.closeDropdown()},e.closeOnOutsideClick=function(o){$(a.findDOMNode(e)).find($(o.target)).length<=0&&e.closeDropdown()},e.showAdminDetails=function(){e.setState({showAdminDetails:!0}),e.context.executeAction(l,{post:e.props.post}),e.closeDropdown()},e.hideAdminDetails=function(){e.setState({showAdminDetails:!1}),e.context.executeAction(d,{post:e.props.post}),e.closeDropdown()},e.showDeleteModal=function(){e.setState({showDeleteModal:!0}),e.closeDropdown()},e.editWithModerationModalSuccess=function(o,t){e.setState({showEditWithModerationModal:!1}),e.showEditReply(o,t)},e.openDropdown=function(){e.setState({expandDropdown:!0}),$("body").on("click",e.closeOnOutsideClick)},e.showEdit=function(){"question"===e.props.post.type?e.showEditQuestion():e.showEditReply(),e.closeDropdown()},e.showSubmissions=function(){var o=e.props,t=o.post,s=o.courseSlug,n=o.itemId,i=new r("/teach/"+s+"/monitor/programming").addQueryParam("assignmentId",n).addQueryParam("userId",t.creatorId).toString();window.open(i,"_blank"),e.closeDropdown()},e.state={expandDropdown:!1,showDeleteModal:!1,canModerate:!1,showAdminDetails:!1,showEditThreadModal:!1,showEditWithModerationModal:!1,showShareModal:!1,showHighlightModal:!1},e}return _inherits(ModerationDropdown,t),ModerationDropdown.prototype.componentWillMount=function componentWillMount(){var o=this,e=this.props,n=e.authenticated,i=e.isSuperuser,t=e.currentForum,r=e.hasModerationRole,s=t&&t.forumType.definition.groupId;s?M(s,n,i).then(function(e){o._isMounted&&o.setState(e)}):this.setState({canModerate:r})},ModerationDropdown.prototype.componentDidMount=function componentDidMount(){this._isMounted=!0},ModerationDropdown.prototype.componentWillUnmount=function componentWillUnmount(){this._isMounted=!1},ModerationDropdown.prototype.closeDropdown=function closeDropdown(){this.setState({expandDropdown:!1}),$("body").off("click",this.closeOnOutsideClick)},ModerationDropdown.prototype.showEditQuestion=function showEditQuestion(){this.setState({showEditThreadModal:!0})},ModerationDropdown.prototype.showEditReply=function showEditReply(e,o){this.context.executeAction(u,{reply:this.props.post,reason:e,dontNotify:o})},ModerationDropdown.prototype.showEditWithModerationModal=function showEditWithModerationModal(){this.setState({showEditWithModerationModal:!0}),this.closeDropdown()},ModerationDropdown.prototype.render=function render(){var t=this,s=this.props,n=s.post,D=s.userId,F=s.forumLink,y=s.courseId,M=s.question,W=s.creator,u=s.hasTeachingRole,l=s.isSuperuser,R=s.isProgrammingItem,a=s.isHighlighted,E=s.onDeleteSuccess,i=this.state,P=i.expandDropdown,C=i.showDeleteModal,k=i.showEditThreadModal,A=i.showEditWithModerationModal,I=i.showFlaggingModal,O=i.showShareModal,x=i.showHighlightModal,d=i.canModerate,S=i.showAdminDetails,H=n.forumType,q="question"===n.type,r=W.userId===D,N=M&&M.creatorId===D,T=b.hasAdminPrivileges(u);return e.createElement("div",{className:"rc-Dropdown align-self-start"},e.createElement("button",{"aria-haspopup":"true","aria-label":"Settings Menu",onClick:this.openDropdown},e.createElement("i",{className:"cif-chevron-down c-dropdown-chevron"})),P&&e.createElement("ul",{className:"styleguide dropdown"},(r||d)&&e.createElement("li",null,e.createElement("button",{"data-js":"edit",onClick:this.onEditClick},o("Edit"))),(r||d)&&e.createElement("li",null,e.createElement("button",{"data-js":"delete",onClick:this.showDeleteModal},o("Delete"))),!r&&e.createElement("li",null,e.createElement("button",{"data-js":"flag",onClick:this.onFlaggingClick},o(n.flagDetails&&n.flagDetails.isActive?"Resolve report":"Report this"))),(u||l)&&S&&e.createElement("li",null,e.createElement("button",{"data-js":"userId",onClick:this.hideAdminDetails},o("Hide User ID"))),(u||l)&&!S&&e.createElement("li",null,e.createElement("button",{"data-js":"userId",onClick:this.showAdminDetails},o("Show User ID"))),R&&T&&e.createElement("li",null,e.createElement("button",{"data-js":"viewSubmissions",onClick:this.showSubmissions},o("View submissions"))),e.createElement("li",null,e.createElement("button",{"data-js":"share",onClick:this.onShareClick},o("Link to Post"))),!q&&(d||l||N)&&j(y,H)&&e.createElement("li",null,e.createElement("button",{"data-js":"highlight",onClick:function onClick(){t.setState({showHighlightModal:!0}),t.closeDropdown()}},!a&&o("Mark as highlighted"),a&&o("Unmark as highlighted")))),C&&e.createElement(h,{post:n,showReasons:!r,onDeleteSuccess:E,handleClose:function handleClose(){return t.setState({showDeleteModal:!1})}}),k&&e.createElement(v,{question:n,courseId:y,showReasons:!r,handleClose:function handleClose(){return t.setState({showEditThreadModal:!1})}}),A&&e.createElement(m,{handleSuccess:this.editWithModerationModalSuccess,handleCancel:function handleCancel(){return t.setState({showEditWithModerationModal:!1})}}),I&&e.createElement(g,{post:n,handleClose:function handleClose(){return t.setState({showFlaggingModal:!1})}}),O&&e.createElement(w,{post:n,forumLink:F,handleClose:function handleClose(){return t.setState({showShareModal:!1})}}),x&&e.createElement(f,{isHighlighted:a,handleCancel:function handleCancel(){return t.setState({showHighlightModal:!1})},handleAccept:function handleAccept(){a?t.context.executeAction(p,{post:n}):t.context.executeAction(c,{post:n}),t.setState({showHighlightModal:!1})}}))},ModerationDropdown}(e.Component),s.propTypes={creator:e.PropTypes.object.isRequired,post:e.PropTypes.object.isRequired,hasTeachingRole:e.PropTypes.bool,onDeleteSuccess:e.PropTypes.func,isProgrammingItem:e.PropTypes.bool,isHighlighted:e.PropTypes.bool,forumLink:e.PropTypes.string,courseSlug:e.PropTypes.string,courseId:e.PropTypes.string,userId:e.PropTypes.number,authenticated:e.PropTypes.bool,isSuperuser:e.PropTypes.bool,hasModerationRole:e.PropTypes.bool,itemId:e.PropTypes.string,question:e.PropTypes.object,currentForum:e.PropTypes.oneOfType([e.PropTypes.instanceOf(y),e.PropTypes.instanceOf(D),e.PropTypes.instanceOf(S)])},s.contextTypes={executeAction:e.PropTypes.func.isRequired},i);module.exports=_.compose(C({fields:["forumType"]}),E(T),P(["CourseMembershipStore","CourseStore","ApplicationStore","ThreadDetailsStore"],function(e,i){var u=e.CourseMembershipStore,d=e.CourseStore,n=e.ApplicationStore,r=e.ThreadDetailsStore,s=i.currentForum,a=i.post,l=a.questionId,o=s&&s.forumType.definition.itemId,t=!!o&&d.getMaterials().getItemMetadata(o),c=t&&t.getTypeName(),p=_(["gradedProgramming","ungradedProgramming"]).includes(c);return{hasTeachingRole:u.hasTeachingRole(),isProgrammingItem:p,itemId:o,isSuperuser:n.isSuperuser(),authenticated:n.isAuthenticatedUser(),question:r.getQuestion(l)}}))(n),module.exports.BaseComponent=n});